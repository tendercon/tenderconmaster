
<div class="row">
  <div class="text-center" style="margin-top: -290px">
  <h2 style="font-size: 30px; font-family: Gotham;">
   ISSUE TRADE DOCUMENTS
  </h2>
  <h5 style="font-size: 20px">
    Securely upload and create additional document set for tendering sub-contractors.
  </h5>
</div>
  <div class="col-md-12" style="margin-top: -200px">  
    <div style="display:none"> 
      <input id="file_input" type="file" style="background-color: transparent;" name="documents"> 
    </div> 
    <div  type="file" id="dir-select" webkitdirectory name="document"> 
      <div class="col-md-8 col-md-offset-2 addenda_dropzone">
        <input type="hidden" name="addenda_type" value="documents">
        <div style="height: 40px"></div>
        <p class="text-center">
          <i class="fa fa-cloud-upload fa-4x upload " aria-hidden="true"></i>
        </p>
        <h1 class="text-center">Drag and drop the documents for this tender from your desktop.</h1>
        <p class="text-center">your tender files and folders into this area</p> 

      </div>
    </div>  
  </div>
</div>
<div>
  <h2 style="font-size: 30px; font-family: Gotham;">
    UPLOAD DOCUMENTS
  </h2>
</div>
<div class="row">
  <div class="admin-form">
    <div class="section">
      <div class="col-md-3 smart-widget sm-left sml-50" style="margin-left: 15px">
        <label class="field">
          <input type="text" name="sm3" id="filter" class="gui-input" placeholder="Search Here">
        </label>
        <label for="sm3" class="button">
          <i class="fa fa-search"></i>
        </label>
      </div>
      <!-- end .smart-widget section -->
    </div>
  </div>
  <div class="col-md-12" style="margin-top: 40px;">
    <% if documents.present? %> 
      <div class="admin-form">
          <div class="row">
            <div class="col-md-9">
              <!--<i class="fa fa-folder folder" aria-hidden="true"></i>
              <i class="fa fa-arrows selected" aria-hidden="true"></i>-->
              <button type="button" class="button btn-success add_folder" >
                 ADD DOC TO NEW FOLDER
              </button>
              <button type="button" class="button btn-warning move_document" >
                 MOVE DOCS
              </button>
              <!--<i class="fa fa-trash remove" aria-hidden="true" onclick="return confirm('Are you sure you want to delete this item?');"></i>-->
              <button type="button" class="button btn-danger remove_document"   onclick="return confirm('Are you sure you want to delete this item?');" id="<%= tender.id %>">
                DELETE DOCS
              </button>
            </div>

            <div class="col-md-3 pull-right">
              
            </div>
          </div>
        </div>
        <div class="addenda_document"> 
          <table  class="table table-bordered responsive" id="document_table"  cellspacing="0" width="100%">
            <thead>
            <tr style="background-color: #2C3E50;color: white;">
              <th><input type="checkbox" class="document_list_master" name="document_list_master"></th>
              <th class="text-center"><h4 style="font-family: Gotham">DOCUMENT</h4></th>
              <th class="text-center"><h4 style="font-family: Gotham">SIZE</h4></th>
              <th class="text-center"><h4 style="font-family: Gotham">Directory</h4></th>
              <th class="text-center"><h4 style="font-family: Gotham">ADD FILE TO FOLDER </h4></th>
            </tr>
            </thead>
            <tbody class="searchable">
            <% if documents.present? %>
                <% documents.each do |t| %>
                    <tr>
                      <td><input type="checkbox" class="document_list" name="documents[]" value="<%= t.id %>"></td>
                      <td class="text-center"><%= t.document_file_name %></td>
                      <td class="text-center"> <%= convert_kb_to_mb t.document_file_size %> MB</td>
                      <td class="text-center"><%= t.directory %></td>
                      <td class="text-center">
                        <i class="fa fa-che ck" aria-hidden="true" style="color: green"></i>
                      </td>
                    </tr>
                <% end %>
            <% end %>
            </tbody>
          </table>   
        </div> 
      </div>
    <% end %>   
  </div> 
  <div class="form-actions text-center pull-right">
    <a href="<%= new_addenda_path(:id => @tender.id,:addenda => params[:addenda],:addenda_type => "documents", :details => true) %>">
      <button type="button" class="btn addenda_submit" style="color:#FFFFFF; background-color:#FF3823 ;border-radius: 2px !important;height: 36px !important;margin-right: 2px; width: 80px;">
        <p style="margin-top: 1px; font-size: 14px">
          BACK
        </p>
      </button>
    </a>

    <a href="<%= new_addenda_path(:id => @tender.id,:addenda => params[:addenda],:addenda_type => "documents",:notify => true) %>">
      <button type="button" class="btn addenda_submit" style="color:#FFFFFF; background-color:#72bb53 ;border-radius: 2px !important;height: 36px !important;margin-right: 0px; width: 80px;">
      <p style="margin-top: 1px; font-size: 14px">
        NEXT
      </p>
    </button>
    </a>
  </div>
  <div style="height: 80px;"></div>
</div>


<%= render  'tenders/document_upload/add_folder_modal' %>
<%= render  'tenders/document_upload/remove_document_modal' %>
<%= render  'tenders/document_upload/add_files_to_document' %>
<%= render  'tenders/document_upload/add_new_folder' %>
<script>
  $(document).ready(function(){
    $('.add_folder').click(function(){
      $('.addenda_document').val("addenda");
      $('#new_folder').modal('show');
    });

    $('#document_table').DataTable({
      "bSort" : false,
      "bPaginate": false,
      "bFilter": false, 
      "bInfo": false,
      "columnDefs": [
        { "visible": false, "targets": 3 }
      ],
      "order": [[ 3, 'asc' ]],
      "displayLength": 25,
      "drawCallback": function ( settings ) {
        var api = this.api();
        var rows = api.rows( {page:'current'} ).nodes();
        var last=null;

        api.column(3, {page:'current'} ).data().each( function ( group, i ) {
          console.log("group:"+group);
          console.log("I -------> :"+i);
          if ( last !== group ) {
            $(rows).eq( i ).before(
                '<tr class="group"><td colspan="3" class="editable" id="'+ i + '" title="'+ group+ '"> '+ group+ '</td>' +
                '<td class="text-center"> <i class="fa fa-file-text add_files" aria-hidden="true"  id="'+ group+ '"></i>'+
                '</td></tr>'
            );

            last = group;
          }
        } );
      }
    });

    $('.editable').click(function(e){
      var i=0;
      var id= $(this).attr('id');
      var title= $(this).attr('title');
      var tender_id= $('.tender_id').val();
      e.stopPropagation();      //<-------stop the bubbling of the event here
      var value = $('#'+id).html();

      console.log(id+i);

      updateVal('#'+id, value,title,tender_id);
    });

    function updateVal(currentEle, value,title,tender_id) {
      console.log("Current Element is"+currentEle);
      console.log("Current TITLE is"+title);
      $(currentEle).html('<input type="checkbox" class="document_list" name="documents[]" id="'+ title+ '"><input class="thVal" maxlength="100" type="text" width="2" value="'+title+'" />');
      $(".thVal").focus();
      $(".thVal").keyup(function (event) {
        if (event.keyCode == 13) {
          $(currentEle).html($(".thVal").val().trim());
          $.ajax({
            method: "POST",
            data: {tender_id:tender_id,new_value:$(this).val(),old_value:title},
            url: "/tenders/rename_file"
          }).done(function (data) {
            //$('.uploaded_docs').html(data);
            //$('.add_folder').hide();
            $('.folder').show();
            $('.document_div_table').html('');
            $('.document_div_table').html(data);
          });
        }
      });

      $(".thVal").focusout(function () { // you can use $('html')
        $(currentEle).html('<input type="checkbox" class="document_list" name="documents[]" id="'+ title+ '">' +$(".thVal").val().trim());
        console.log("tender_id"+tender_id);
        console.log("NEW VALUE:"+$(this).val());
        $.ajax({
          method: "POST",
          data: {tender_id:tender_id,new_value:$(this).val(),old_value:title},
          url: "/tenders/rename_file"
        }).done(function (data) {
          //$('.uploaded_docs').html(data);
          //$('.add_folder').hide();
          $('.folder').show();
          $('.document_div_table').html('');
          $('.document_div_table').html(data);
        });

      });
    }

    $('.document_list_master').change(function(){
      console.log("ddjhasj");
      $('.document_list').click();
      $('.document_list').prop('checked',$(this).prop("checked"));
    });
  });
</script>