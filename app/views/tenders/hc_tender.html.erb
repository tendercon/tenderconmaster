<div class="row">
  <div class="col-md-12">
    <h2><%= "##{@tender.tendercon_id}- #{@tender.title}"  %></h2>
    <div class="portlet-body" style="color: #2B3642;">
        <div class="tabbable-line">

          <ul class="nav nav-tabs ">
            <% if params[:addenda].present? || params[:control].present? || params[:rfi].present? || params[:quote].present? || params[:subcontractors].present? %>
                <li ><a href="#info" data-toggle="tab" id="<%= @tender.id %>">Details</a></li>
            <% else %>
                <li class="active"><a href="#info" data-toggle="tab" id="<%= @tender.id %>">Details</a></li>
            <% end %>

            <% if params[:subcontractors].present? %>
                <li class="active"><a href="#sub" data-toggle="tab" id="<%= @tender.id %>">Subcontractors</a></li>
            <% else %>
                <li><a href="#sub" data-toggle="tab" id="<%= @tender.id %>">Subcontractors</a></li>
            <% end %>

            <% if params[:control].present? %>
                <li class="active"><a href="#document_control" data-toggle="tab" id="<%= @tender.id %>">Document Control</a></li>
            <% else %>
                <li><a href="#document_control" data-toggle="tab" id="<%= @tender.id %>">Document Control</a></li>
            <% end %>

            <% if params[:addenda].present? %>
                <li class="active"><a href="#addenda" data-toggle="tab" id="<%= @tender.id %>">Addenda</a></li>
            <% else %>
                <li><a href="#addenda" data-toggle="tab" id="<%= @tender.id %>">Addenda</a></li>
            <% end %>
            <!--<li><a href="#chat" data-toggle="tab" id="<%#= @tender.id %>">Chat</a></li>-->

            <%# if params[:rfi].present? %>
                <!--<li class="active"><a href="#rfi" data-toggle="tab" id="<%#= @tender.id %>">RFIs <span class="badge badge-default" style="background-color: red"> <%#= Rfi.rfi_count(@tender.id) %> </span></a></li>-->
            <%# else %>
                  <!--<li ><a href="#rfi" data-toggle="tab" id="<%#= @tender.id %>">RFIs <%#= Rfi.rfi_count(@tender.id) %></a></li>-->
            <%# end %>
            <% if params[:quote].present? %>
                <li class="active"><a href="#quote" data-toggle="tab" id="<%= @tender.id %>">Quotes</a></li>
            <% else %>
                <li><a href="#quote" data-toggle="tab" id="<%= @tender.id %>">Quotes</a></li>
            <% end %>

            <!--<li class="pull-right">
              <a href="#" class="wiki btn-default ">
                  <i class="fa fa-question-circle fa-2x"></i>
              </a>
            </li>-->

            <!--<li class="pull-right">
             <div class="page-toolbar">
               <div class="btn-group pull-right">
                 <button type="button" class="btn green btn-sm btn-outline dropdown-toggle" data-toggle="dropdown"> Actions
                   <i class="fa fa-angle-down"></i>
                 </button>
                 <ul class="dropdown-menu pull-right" role="menu">
                   <li>
                     <a href="#!" class="full_screen" ><i class="fa fa-arrows-alt"></i> Full Screen</a>

                   </li>
                 </ul>
               </div>
             </div>
           </li>-->
            <!--<li class="pull-right dropdown dropdown-extended dropdown-inbox">
              <a href="javascript:;" class="dropdown-toggle" data-toggle="dropdown" data-hover="dropdown" data-close-others="true">
                &lt;!&ndash;<img alt="" class="img-circle" src="" />
                <i class="fa fa-bars" aria-hidden="true"></i>&ndash;&gt;
                <button type="button" class="btn green btn-sm btn-outline dropdown-toggle" data-toggle="dropdown"> Actions
                  <i class="fa fa-angle-down"></i>
                </button>
              </a>
              <ul class="dropdown-menu pull-right" role="menu">
                <li>
                  <a href="#!" class="full_screen" ><i class="fa fa-arrows-alt"></i> Full Screen</a>
                </li>
              </ul>
            </li>-->
            <!--<li class="pull-right">
              <div class="dropdown">
                <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
                  <i class="fa fa-bars" aria-hidden="true"></i> &lt;!&ndash;<span class="caret"></span>&ndash;&gt;</button>

              </div>
            </li>-->
          </ul>
        </div>


      </div>
    </div>
    <input type="hidden" class="tender_id" value="<%= @tender.id %>">
      <div id="my-tab-content" class="tab-content">
        <div class="row">
          <div class="form-group"></div>
        </div>
        <% if params[:addenda].present? || params[:control].present? || params[:rfi].present? || params[:quote].present? || params[:subcontractors].present? %>
            <div class="tab-pane  col-md-12" id="info">
              <%= render 'tender_info' %>
            </div>
        <% else %>
            <div class="tab-pane active col-md-12" id="info">
              <%= render 'tender_info' %>
            </div>
        <% end %>


        <% if params[:subcontractors].present? %>
            <div class="tab-pane active col-md-12" id="sub"></div>
        <% else %>
            <div class="tab-pane col-md-12" id="sub"></div>
        <% end %>


        <% if params[:addenda].present? %>
            <div class="tab-pane active col-md-12" id="addenda">
              <%= render :partial => 'addendas/new_lists', :locals => { :addendas => @addendas,:tender => @tender} %>
            </div>
        <% else %>
            <div class="tab-pane col-md-12" id="addenda">

            </div>
        <% end %>

        <% if params[:rfi].present? %>
            <div class="tab-pane active col-md-12" id="rfi">

            </div>
        <% else %>
            <div class="tab-pane col-md-12" id="rfi">

            </div>
        <% end %>

        <% if params[:control].present? %>
            <div class="tab-pane active  col-md-12" id="document_control">

            </div>
        <% else %>
            <div class="tab-pane  col-md-12" id="document_control">

            </div>
        <% end %>

        <div class="tab-pane col-md-12" id="chat">
          <%#= render 'tender_chat' %>
        </div>
        <% if params[:quote].present? %>
            <div class="tab-pane active col-md-12" id="quote">

            </div>
        <% else %>
            <div class="tab-pane col-md-12" id="quote">

            </div>
        <% end %>

      </div>

  </div>

  <div class="row">
    <div class="form-group">

    </div>

  </div>
</div>

<div class="chat">
  <div id="chat_modal" class="modal fade"   style="margin-top: 100px; width: 100%" >
    <div class="modal-dialog">
      <!-- Modal content-->
      <div class="modal-content col-md-24">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <div class="col-md-24 col-md-20 col-md-offset-2">
            <p class="text-center" style="font-size: 20px">
              New Chat
            </p>
            <label>Select the individual SC's or trade groups you wish to chat with</label>
            <input type="text" class="form-control" placeholder="Add Participants" id="chat_member">
          </div>
          <div class="row">
            <div class="form-group"></div>
          </div>
        </div>
        <br>

        <div class="modal-body" style="overflow-y: auto;height: 250px;">
          <table  class="table table-bordered sub_table">
            <tbody>
            <% if @tender_trade_array.present?  %>
              <% @tender_trade_array.uniq.each do |c| %>
                <tr>
                  <td class="trade_name">
                    <%= get_trade_name c %></td>
                  </td>
                  <td class="trade_name">
                    <button class="btn btn-default invite" id="<%= c %>" alt="<%= get_trade_name c %>">
                      Invite All
                    </button>
                  </td>
                </tr>

                <% if (get_sc_user  c,@tender.id).present? %>
                  <% (get_sc_user  c,@tender.id).each_with_index do |u,index| %>
                    <tr>
                      <td class="text-center"><%= get_user_company_name u %></td>
                      <td>
                        <input type="checkbox" class="member <%= c %>" alt="<%= u %>" id="<%= c %>" title="<%= get_user_company_name u %>">
                      </td>
                    </tr>
                  <% end %>
                <% end %>
              <% end %>
            <% else %>
                <tr>
                  <td style="color: grey;">No quotes available.</td>
                </tr>
            <% end %>
            </tbody>
          </table>


        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-info start_message" data-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

</div>

<div class="invite_more" style="width: 100%">
  <div id="invite_more_modal" class="modal fade" role="dialog"   style="overflow-y:scroll;" >
    <div class="modal-dialog">
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close close_invite_more_modal" data-dismiss="modal">&times;</button>
          <div class="text-center">
            <p class="text-center" style="font-size: 20px">
              Invite Subcontractor
            </p>
          </div>
          <div class="row">
            <div class="form-group"></div>
          </div>
        </div>
        <br>

        <div class="modal-body" style="overflow-y: auto">


          <div class="row">
            <div class="form-group"></div>
          </div>
          <br><br>
          <div class="col-md-12">
            <!--<button class="btn btn-success add_more" type="button">
              <i class="fa fa-plus-circle" aria-hidden="true"></i>Invite More
            </button>-->
            <div class="error text-center" style="display: none">
              <div class="alert alert-danger open-sans-regular" id="users_error">
                <button type="button" class="close" data-dismiss="alert">&times;</button>

                <div class="notice" style="font-size: 14px;">
                  <label>Company, Full Name, Email and Trades are required.</label>
                </div>

              </div>
            </div>
            <div class="email_error text-center" style="display: none">
              <div class="alert alert-danger open-sans-regular" id="users_error">
                <button type="button" class="close" data-dismiss="alert">&times;</button>

                <div class="notice" style="font-size: 14px;">
                  <label>Email address field is not valid.</label>
                </div>

              </div>
            </div>
            <div style="height: 30px"></div>
            <div class="new_invite">
              <div class="form-group">
                <label class="control-label">Company</label>
              </div>

              <div class="form-group">
                <input class="form-control company" name="companies[]" value="">
              </div>
              <div class="form-group">
                <label class="control-label">Full Name</label>
              </div>

              <div class="form-group">
                <input class="form-control f_name" name="names[]" value="">
              </div>

              <div class="form-group">
                  <label class="control-label">Email</label>
              </div>

              <div class="form-group">
                <input class="form-control email" name="emails[]" value="">
              </div>

              <div class="form-group">
                <label class="control-label">TO QUOTE FOR</label>
              </div>

              <div class="form-group">
                <select class="form-control trades">
                  <option value="all">None</option>
                  <% if @tender_trades.present? %>
                    <% @tender_trades.uniq.each do |t| %>
                      <option value="<%= t.trade_id %>"><%= get_trade_name t.trade_id %></option>
                    <% end %>
                  <% end %>
                </select> 
              </div>
              <div class="form-group">
                <div class="checkbox">
                  <label><input type="checkbox" class="save_to_sub" id="save_to_sub">Save this Subcontractor to My Network</label>
                </div>
              </div>
            </div>
          </div>
          <div style="height: 40px"></div>
          <div class="col-md-12">
            <div style="height: 40px"></div>
            <div class="new_invite_div"></div>

          </div>
        </div>
        <div class="modal-footer">
          <div class="text-center">
            <button type="button" class="btn btn-info send_invite">Invite</button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>


<div id="sample_modal" class=" popup-basic admin-form mfp-with-anim mfp-hide">
  <div class="panel">
    <div class="panel-heading">
              <span class="panel-title">
                <i class="fa fa-rocket"></i>Leave a comment</span>
    </div>
    <!-- end .panel-heading section -->

    <form method="post" action="/" id="comment">
      <div class="panel-body p25">
        <div class="section row">
          <div class="col-md-6">
            <label for="firstname" class="field prepend-icon">
              <input type="text" name="firstname" id="firstname" class="gui-input" placeholder="First name...">
              <label for="firstname" class="field-icon">
                <i class="fa fa-user"></i>
              </label>
            </label>
          </div>
          <!-- end section -->

          <div class="col-md-6">
            <label for="lastname" class="field prepend-icon">
              <input type="text" name="lastname" id="lastname" class="gui-input" placeholder="Last name...">
              <label for="lastname" class="field-icon">
                <i class="fa fa-user"></i>
              </label>
            </label>
          </div>
          <!-- end section -->

        </div>
        <!-- end section row section -->

        <div class="section row">
          <div class="col-md-6">
            <label for="email" class="field prepend-icon">
              <input type="email" name="email" id="email" class="gui-input" placeholder="Email address">
              <label for="email" class="field-icon">
                <i class="fa fa-envelope"></i>
              </label>
            </label>
          </div>
          <!-- end section -->

          <div class="col-md-6">
            <label for="website" class="field prepend-icon">
              <input type="url" name="website" id="lastname" class="gui-input" placeholder="Website url...">
              <label for="website" class="field-icon">
                <i class="fa fa-globe"></i>
              </label>
            </label>
          </div>
          <!-- end section -->

        </div>
        <!-- end section row section -->

        <div class="section">
          <label for="comment" class="field prepend-icon">
            <textarea class="gui-textarea" id="comment" name="comment" placeholder="Your comment"></textarea>
            <label for="comment" class="field-icon">
              <i class="fa fa-comments"></i>
            </label>
                    <span class="input-footer">
                      <strong>Hey You:</strong> We expect a great comment...</span>
          </label>
        </div>
        <!-- end section -->

      </div>
      <!-- end .form-body section -->

      <div class="panel-footer">
        <button type="submit" class="button btn-primary">Post Comment</button>
        <button type="button" class="button btn-default popup-modal-dismiss">Close</button>
      </div>
      <!-- end .form-footer section -->
    </form>
  </div>
  <!-- end: .panel -->
</div>

<script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyA7B-_hoQVA07h-qSd3E-HXxyXnM9W4zC8&libraries=places&sensor=false"></script> 
<script>


  $(document).ready(function(){

    $('.add_more').click(function(){
      $('.new_invite_div').append("<%= escape_javascript(render :partial => 'tenders/invites_for_modal') %>");
    });

    $('.save_to_sub').click(function(){
       $(this).val(1);
    });

    $('.send_invite').click(function(){
      var emails = [];
      var names = [];
      var trades = [];
      var companies = [];
      var tender_id = $('.tender_id').val();
      var save_to_sub = $('.save_to_sub').val();

      $('.company').each(function(){
        companies.push($(this).val());
      });

      $('.f_name').each(function(){
        names.push($(this).val());
      });
      console.log('names:'+names);
      $('.email').each(function(){
        emails.push($(this).val());
      });

      $('.trades').each(function(){
        if(parseInt($(this).val()) > 0){
          trades.push($(this).val())
        }
      });

      for(var a=0; a < emails.length; a++){
        console.log(validateEmail(emails[a]));
      }


      if(emails.length > 0 && names.length > 0 && companies.length > 0 && trades.length > 0){
        if(validateEmail(emails[0])){
          $.ajax({
            method: "POST",
            data: {tender_id:tender_id,emails:emails,names:names,trades:trades,companies:companies,save_to_sub:save_to_sub},
            url: "/tenders/invite_more_sub"
          }).done(function (data) {
            $('.close_invite_more_modal').click();
            $('#invite_more_modal').modal('hide');
            //$('.contractors').html(data);
            $('.f_name').each(function(){
              $(this).val('');
            });
            console.log('names:'+names);
            $('.email').each(function(){
              $(this).val('');

            });
            $('.trades').each(function(){
              if(parseInt($(this).val()) > 0){
                $(this).val('')
              }
            });

            $('.company').each(function(){
              if(parseInt($(this).val()) > 0){
                $(this).val('')
              }
            });

            $('.invited_div').html(data);
            $('.company').val('');

          });
        }else{
          $('.email_error').show();
          $('.error').hide();
        }

      }else{
        $('.error').show();
        $('.email_error').hide();
      }


    });


    function validateEmail(email) {
      var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      return re.test(email);
    }

    $('.tenders').each(function(){
      var id =  $(this).val();
      var add = $('.add'+id).val();
    });

    var tender_id = $('.tender_id').val();

    <% if params[:control] %>
      $.ajax({
        method: "POST",
        data: {tender_id:tender_id},
        url: "/tenders/get_document_control"
      }).done(function (data) {
        $('#document_control').html(data);
      });
    <% end %>

    <% if params[:subcontractors].present? %>
      var request_target = 0;
      <% if params[:open].present? %>
        request_target = 1;
      <% end %>

      $.ajax({
        method: "POST",
        data: {tender_id:tender_id,request_target:request_target},
        url: "/tenders/get_latest_sub"
      }).done(function (data) {
        $('#sub').html(data);
      });
    <% end %>

    <% if params[:rfi].present? %>
      $.ajax({
        method: "POST",
        data: {tender_id:tender_id},
        url: "/rfis/get_latest_rfis"
      }).done(function (data) {
        $('#rfi').html(data);
      });
    <% end %>

    <% if params[:quote].present? %>
      <% if params[:notification].present? %>
        var quote_id = <%= params[:notification] %>
      <% end %>
      $.ajax({
        method: "POST",
        data: {tender_id:tender_id,quote_id:quote_id},
        url: "/quotes/get_latest_quotes"
      }).done(function (data) {
        $('#quote').html(data);
      });
    <% end %>


    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
      var target = $(e.target).attr("href"); // activated tab
      var id = $(e.target).attr("id");
      var tender_id = $('.tender_id').val();
      console.log("TARGET:"+target);
      if(target == '#chat'){
        $.ajax({
          method: "POST",
          data: {tender_id:tender_id},
          url: "/tenders/get_latest_chat"
        }).done(function (data) {
          $('#chat').html(data);
        });
      }else if(target == '#sub'){

        $.ajax({
          method: "POST",
          data: {tender_id:tender_id},
          url: "/tenders/get_latest_sub"
        }).done(function (data) {
          $('#sub').html(data);
        });

      }else if(target == '#quote'){

        /*$.ajax({
          method: "POST",
          data: {tender_id:tender_id},
          url: "/tenders/get_latest_quote"
        }).done(function (data) {
          $('#quote').html(data);
        });*/

        $.ajax({
          method: "POST",
          data: {tender_id:tender_id},
          url: "/quotes/get_latest_quotes"
        }).done(function (data) {
          $('#quote').html(data);
        });

      }else if(target == '#rfi'){
        var tender_id = $('.tender_id').val();
        $.ajax({
          method: "POST",
          data: {tender_id:tender_id},
          url: "/rfis/get_latest_rfis"
        }).done(function (data) {
          $('#rfi').html(data);
        });
      }else if(target == '#addenda'){
        var tender_id = $('.tender_id').val();
        $.ajax({
          method: "POST",
          data: {tender_id:tender_id},
          url: "/addendas/get_addendas"
        }).done(function (data) {
          $('#addenda').html(data);
        });
      }else if(target == '#document_control'){
        $.ajax({
          method: "POST",
          data: {tender_id:tender_id},
          url: "/tenders/get_document_control"
        }).done(function (data) {
          $('#document_control').html(data);
        });
      }
    });


      var map;
      var id = $('.tender_id').val();
      var myLatLng;
      load_map();
      function load_map() {

        var add = $('.add'+id).val();

        $.ajax({
          method: "POST",
          data: {add:add},
          url: "/tenders/get_latling"
        }).done(function (data) {

          myLatLng = {lat:data.latitude, lng: data.longitude};

          map = new google.maps.Map(document.getElementById('map_'+id), {
            zoom: 15,
            center: myLatLng
          });

          var marker = new google.maps.Marker({
            position: myLatLng,
            map: map
          });

          google.maps.event.addListenerOnce(map, 'idle', function() {
            google.maps.event.trigger(map, 'resize');
            map.setCenter(myLatLng);
          });
        });

      }

      $('a[href="#red"]').on('shown.bs.tab', function() {
        google.maps.event.trigger(map, 'resize');
        load_map();
      });

      $('.full_screen').click(function(){
        $('.menu-toggler').click();
      });


      $('.wiki').magnificPopup({
        type: 'inline',
        items: {src: '#sample_modal'},
        preloader: false,
        modal: true
      });

      $('.popup-modal-dismiss').click(function(){
        $.magnificPopup.close();
        $('form')[0].reset();
      });


  })


</script>